
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

typedef
struct {
 struct { int x,y,w,h; } rects[8*8];
 struct { int x1,y1,x2,y2,x3,y3; } tris[8*8*2];
 int num_rects, num_tris;
} DST_char;

DST_char *DST_font = NULL;
char **BBCFont = NULL;

 void ____Triangle(int n, float x1,float y1,float x2,float y2,float x3,float y3){
  DST_font[n].tris[DST_font[n].num_tris].x1 = x1;
  DST_font[n].tris[DST_font[n].num_tris].y1 = y1;
  DST_font[n].tris[DST_font[n].num_tris].x2 = x2;
  DST_font[n].tris[DST_font[n].num_tris].y2 = y2;
  DST_font[n].tris[DST_font[n].num_tris].x3 = x3;
  DST_font[n].tris[DST_font[n].num_tris].y3 = y3;
  DST_font[n].num_tris += 1;
  #if 0
  if( DST_font[n].num_tris >= 8*8*2){
   printf("OH SHIT! NO!!!!! %d\n",DST_font[n].num_tris);
  }
  #endif
  //printf("char '%c': added triangle(%d,%d, %d,%d, %d,%d)\n",n,(int)x1,(int)y1, (int)x2,(int)y2, (int)x3,(int)y3);
 }
 int ____CharPix( int n, int x, int y ){
  if( x<0 || x>7 || y<0 || y>7 ) return 0;
  return !!(BBCFont[n][y] & (128>>x));
 } 
void BuildDSTchar(unsigned char n){
 DST_font[n].num_tris = 0;
 DST_font[n].num_rects = 0;
 const int xs=2;
 const int ys=2;
 int step = 8 * xs;
 #define drawscaledtext_right 8
 #define drawscaledtext_left  4
 #define drawscaledtext_above 2
 #define drawscaledtext_below 1 
 int X,Y;
 for(X=0; X<8; X++){
  for(Y=0; Y<8; Y++){ 
   int xx1 = xs*X;
   int yy1 = ys*Y;
   if( !____CharPix(n,X,Y) ){   
    int xx2,yy2,xc,yc;
    xc  = xx1+(xs>>1);
    yc  = yy1+(ys>>1);
    xx2 = xx1+xs;
    yy2 = yy1+ys;
    int surroundings
          =
           (-____CharPix( n, X,   Y+1 )&drawscaledtext_above) 
            |
           (-____CharPix( n, X-1, Y   )&drawscaledtext_left) 
            |
           (-____CharPix( n, X,   Y-1 )&drawscaledtext_below) 
            |
           (-____CharPix( n, X+1, Y   )&drawscaledtext_right) ;
    int nsurrounds = 0;
    int i = surroundings;
    while(i){
     nsurrounds += (i&1);
     i = i >> 1;
    }     
    if( nsurrounds <= 2)
    switch( surroundings ){
     case (drawscaledtext_above+drawscaledtext_left): { // upper left
      ____Triangle( n,  xx1,yy1, xx1,yy2, xx2,yy2);
     } break;
     case (drawscaledtext_above+drawscaledtext_right): { // upper right
      ____Triangle( n, xx1,yy2, xx2,yy2, xx2,yy1);
     } break;
     case (drawscaledtext_below+drawscaledtext_left): { // lower left
      ____Triangle( n, xx1,yy2, xx1,yy1, xx2,yy1);
     } break;
     case (drawscaledtext_below+drawscaledtext_right): { // lower right
      ____Triangle( n, xx1,yy1, xx2,yy1, xx2,yy2);
     } break;
    }
    else if( nsurrounds == 3){ // x split
     if( surroundings & drawscaledtext_above ) ____Triangle( n, xx1,yy2, xc,yc, xx2,yy2);
     if( surroundings & drawscaledtext_left  ) ____Triangle( n, xx1,yy1, xc,yc, xx1,yy2);
     if( surroundings & drawscaledtext_below ) ____Triangle( n, xx1,yy1, xc,yc, xx2,yy1);
     if( surroundings & drawscaledtext_right ) ____Triangle( n, xx2,yy1, xc,yc, xx2,yy2);
    }else{
     ____Triangle( n, xx1,yy1, xc,yy1, xx1,yc ); // top left
     ____Triangle( n, xx1,yy2, xx1,yc, xc,yy2); // bottom left
     ____Triangle( n, xc,yy1,  xx2, yy1, xx2,yc); //top right
     ____Triangle( n, xc,yy2,  xx2, yy2, xx2,yc); // bottom right
    }
   } //endif CharPix(X,Y)
  }//next Y
 }//next X
 unsigned long long int thischar = *(unsigned long long int*)BBCFont[n];
 unsigned char *thischarn = (unsigned char *)&thischar;
 //int Pix(int x, int y){
 // return !!( thischarn[y] & (128>>x) );
 //}
 #define Pix(xxx,yyy) !!( thischarn[(int)(yyy)] & (128 >> (int)(xxx)) )
 int W=0,H=0,xx,yy,widthmask;
 for(X=0; X<8; X++){
  for(Y=0; Y<8; Y++){
   if( Pix(X,Y) ){
    W=0;H=0;
    xx=X;yy=Y;
    widthmask=0;
    while( xx<8 && Pix(xx,yy) ){
     widthmask |= (128>>xx);
     W += 1; xx+=1;
    }
    while( yy<8 && ((thischarn[yy]&widthmask)==widthmask) ){
     thischarn[yy] &= ~widthmask;
     H += 1; yy+=1;
    }
    DST_font[n].rects[DST_font[n].num_rects].x=X*2;
    DST_font[n].rects[DST_font[n].num_rects].y=Y*2;
    DST_font[n].rects[DST_font[n].num_rects].w=W*2;
    DST_font[n].rects[DST_font[n].num_rects].h=H*2;
    DST_font[n].num_rects += 1;
    //printf("char '%c': added rectangle(%d,%d, %d,%d)\n",n,X,Y,W,H);
   }
  }
 }
 return;
}
#undef drawscaledtext_right 
#undef drawscaledtext_left  
#undef drawscaledtext_above 
#undef drawscaledtext_below 

void CustomChar(unsigned char n, unsigned char b0,unsigned char b1,unsigned char b2,unsigned char b3,unsigned char b4,unsigned char b5,unsigned char b6,unsigned char b7){
 if( BBCFont == NULL ) return;
 BBCFont[n][0]=b0;
 BBCFont[n][1]=b1;
 BBCFont[n][2]=b2;
 BBCFont[n][3]=b3;
 BBCFont[n][4]=b4;
 BBCFont[n][5]=b5;
 BBCFont[n][6]=b6;
 BBCFont[n][7]=b7;
 if( DST_font ){
  BuildDSTchar(n);
 }
}

void DefaultFont(){
 if( BBCFont == NULL ) return;

 #define makedigit(a,b,c,d, e,f,g,h)	\
  ( (unsigned long long int)(a)		\
  | (unsigned long long int)(b)<<8	\
  | (unsigned long long int)(c)<<16	\
  | (unsigned long long int)(d)<<24	\
  | (unsigned long long int)(e)<<32	\
  | (unsigned long long int)(f)<<40	\
  | (unsigned long long int)(g)<<48	\
  | (unsigned long long int)(h)<<56)	

 unsigned long long int digits[10] = {
  makedigit(
   0b11000000,
   0b11000000,
   0b11000000,
   0b11000000,
   0b11000000, 0, 0, 0),
  makedigit(
   0b10000000,
   0b10000000,
   0b10000000,
   0b10000000,
   0b10000000, 0, 0, 0),
  makedigit(
   0b11000000,
   0b01000000,
   0b01000000,
   0b10000000,
   0b11000000, 0, 0, 0),
  makedigit(
   0b11000000,
   0b01000000,
   0b10000000,
   0b01000000,
   0b11000000, 0, 0, 0),
  makedigit(
   0b01000000,
   0b11000000,
   0b11000000,
   0b01000000,
   0b01000000, 0, 0, 0),
  makedigit(
   0b11000000,
   0b10000000,
   0b11000000,
   0b01000000,
   0b11000000, 0, 0, 0),
  makedigit(
   0b01000000,
   0b10000000,
   0b10000000,
   0b11000000,
   0b11000000, 0, 0, 0),
  makedigit(
   0b11000000,
   0b01000000,
   0b01000000,
   0b10000000,
   0b10000000, 0, 0, 0),
  makedigit(
   0b11000000,
   0b11000000,
   0b00000000,
   0b11000000,
   0b11000000, 0, 0, 0),
  makedigit(
   0b11000000,
   0b11000000,
   0b01000000,
   0b01000000,
   0b01000000, 0, 0, 0)
 };

 #define positiondigit(d,x,y) \
  (((d)>>(x))<<(y<<3)) 
 
 unsigned long long int border = makedigit( 0, 0, 0, 0, 0, 0, 0, 0b11111111);
 for(int i=0;i<256;i++){
  if(i==32) i=127;
  unsigned long long int d = ( ( i<100 ? 0 : positiondigit( digits[i/10/10%10], 0,1) )
                           | (i<10 ? 0 : positiondigit( digits[i/10%10], 3,1))
                           | positiondigit( digits[i%10], 6,1) ) | border;
  unsigned char *dp = (unsigned char*)&d;
  CustomChar(i, dp[0], dp[1], dp[2], dp[3], dp[4], dp[5], dp[6], dp[7] );
 }
 #undef positiondigit
 #undef makedigit
 for( int i=0; i<3; i++){
  CustomChar( (int[]){ 9, 10, 32 }[i], 0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0 );
 }
 CustomChar(33,0x18,0x18,0x18,0x18,0x18,0x0,0x18,0x0);
 CustomChar(34,0x6C,0x6C,0x6C,0x0,0x0,0x0,0x0,0x0);
 CustomChar(35,0x6C,0x6C,0xFE,0x6C,0xFE,0x6C,0x6C,0x0);
 CustomChar(36,0x18,0x3E,0x78,0x3C,0x1E,0x7C,0x18,0x0);
 CustomChar(37,0x62,0x66,0xC,0x18,0x30,0x66,0x46,0x0);
 CustomChar(38,0x70,0xD8,0xD8,0x70,0xDA,0xCC,0x76,0x0);
 CustomChar(39,0xC,0xC,0x18,0x0,0x0,0x0,0x0,0x0);
 CustomChar(40,0xC,0x18,0x30,0x30,0x30,0x18,0xC,0x0);
 CustomChar(41,0x30,0x18,0xC,0xC,0xC,0x18,0x30,0x0);
 CustomChar(42,0x44,0x6C,0x38,0xFE,0x38,0x6C,0x44,0x0);
 CustomChar(43,0x0,0x18,0x18,0x7E,0x18,0x18,0x0,0x0);
 CustomChar(44,0x0,0x0,0x0,0x0,0x0,0x18,0x18,0x30);
 CustomChar(45,0x0,0x0,0x0,0xFE,0x0,0x0,0x0,0x0);
 CustomChar(46,0x0,0x0,0x0,0x0,0x0,0x18,0x18,0x0);
 CustomChar(47,0x0,0x6,0xC,0x18,0x30,0x60,0x0,0x0);
 CustomChar(48,0x7C,0xC6,0xCE,0xD6,0xE6,0xC6,0x7C,0x0);
 CustomChar(49,0x18,0x38,0x18,0x18,0x18,0x18,0x7E,0x0);
 CustomChar(50,0x7C,0xC6,0xC,0x18,0x30,0x60,0xFE,0x0);
 CustomChar(51,0x7C,0xC6,0x6,0x1C,0x6,0xC6,0x7C,0x0);
 CustomChar(52,0x1C,0x3C,0x6C,0xCC,0xFE,0xC,0xC,0x0);
 CustomChar(53,0xFE,0xC0,0xFC,0x6,0x6,0xC6,0x7C,0x0);
 CustomChar(54,0x3C,0x60,0xC0,0xFC,0xC6,0xC6,0x7C,0x0);
 CustomChar(55,0xFE,0x6,0xC,0x18,0x30,0x30,0x30,0x0);
 CustomChar(56,0x7C,0xC6,0xC6,0x7C,0xC6,0xC6,0x7C,0x0);
 CustomChar(57,0x7C,0xC6,0xC6,0x7E,0x6,0xC,0x78,0x0);
 CustomChar(58,0x0,0x0,0x18,0x18,0x0,0x18,0x18,0x0);
 CustomChar(59,0x0,0x0,0x18,0x18,0x0,0x18,0x18,0x30);
 CustomChar(60,0x6,0x1C,0x70,0xC0,0x70,0x1C,0x6,0x0);
 CustomChar(61,0x0,0x0,0xFE,0x0,0xFE,0x0,0x0,0x0);
 CustomChar(62,0xC0,0x70,0x1C,0x6,0x1C,0x70,0xC0,0x0);
 CustomChar(63,0x7C,0xC6,0xC6,0xC,0x18,0x0,0x18,0x0);
 CustomChar(64,0x7C,0xC6,0xDE,0xD6,0xDC,0xC0,0x7C,0x0);
 CustomChar(65,0x7C,0xC6,0xC6,0xFE,0xC6,0xC6,0xC6,0x0);
 CustomChar(66,0xFC,0xC6,0xC6,0xFC,0xC6,0xC6,0xFC,0x0);
 CustomChar(67,0x7C,0xC6,0xC0,0xC0,0xC0,0xC6,0x7C,0x0);
 CustomChar(68,0xF8,0xCC,0xC6,0xC6,0xC6,0xCC,0xF8,0x0);
 CustomChar(69,0xFE,0xC0,0xC0,0xFC,0xC0,0xC0,0xFE,0x0);
 CustomChar(70,0xFE,0xC0,0xC0,0xFC,0xC0,0xC0,0xC0,0x0);
 CustomChar(71,0x7C,0xC6,0xC0,0xCE,0xC6,0xC6,0x7C,0x0);
 CustomChar(72,0xC6,0xC6,0xC6,0xFE,0xC6,0xC6,0xC6,0x0);
 CustomChar(73,0x7E,0x18,0x18,0x18,0x18,0x18,0x7E,0x0);
 CustomChar(74,0x3E,0xC,0xC,0xC,0xC,0xCC,0x78,0x0);
 CustomChar(75,0xC6,0xCC,0xD8,0xF0,0xD8,0xCC,0xC6,0x0);
 CustomChar(76,0xC0,0xC0,0xC0,0xC0,0xC0,0xC0,0xFE,0x0);
 CustomChar(77,0xC6,0xEE,0xFE,0xD6,0xD6,0xC6,0xC6,0x0);
 CustomChar(78,0xC6,0xE6,0xF6,0xDE,0xCE,0xC6,0xC6,0x0);
 CustomChar(79,0x7C,0xC6,0xC6,0xC6,0xC6,0xC6,0x7C,0x0);
 CustomChar(80,0xFC,0xC6,0xC6,0xFC,0xC0,0xC0,0xC0,0x0);
 CustomChar(81,0x7C,0xC6,0xC6,0xC6,0xCA,0xCC,0x76,0x0);
 CustomChar(82,0xFC,0xC6,0xC6,0xFC,0xCC,0xC6,0xC6,0x0);
 CustomChar(83,0x7C,0xC6,0xC0,0x7C,0x6,0xC6,0x7C,0x0);
 CustomChar(84,0xFE,0x18,0x18,0x18,0x18,0x18,0x18,0x0);
 CustomChar(85,0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0x7C,0x0);
 CustomChar(86,0xC6,0xC6,0x6C,0x6C,0x38,0x38,0x10,0x0);
 CustomChar(87,0xC6,0xC6,0xD6,0xD6,0xFE,0xEE,0xC6,0x0);
 CustomChar(88,0xC6,0x6C,0x38,0x10,0x38,0x6C,0xC6,0x0);
 CustomChar(89,0xC6,0xC6,0x6C,0x38,0x18,0x18,0x18,0x0);
 CustomChar(90,0xFE,0xC,0x18,0x30,0x60,0xC0,0xFE,0x0);
 CustomChar(91,0x7C,0x60,0x60,0x60,0x60,0x60,0x7C,0x0);
 CustomChar(92,0x0,0x60,0x30,0x18,0xC,0x6,0x0,0x0);
 CustomChar(93,0x3E,0x6,0x6,0x6,0x6,0x6,0x3E,0x0);
 CustomChar(94,0x10,0x38,0x6C,0xC6,0x82,0x0,0x0,0x0);
 CustomChar(95,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0xFF);
 CustomChar(96,0x60,0x30,0x18,0x0,0x0,0x0,0x0,0x0);
 CustomChar(97,0x0,0x0,0x7C,0x6,0x7E,0xC6,0x7E,0x0);
 CustomChar(98,0xC0,0xC0,0xFC,0xC6,0xC6,0xC6,0xFC,0x0);
 CustomChar(99,0x0,0x0,0x7C,0xC6,0xC0,0xC6,0x7C,0x0);
 CustomChar(100,0x6,0x6,0x7E,0xC6,0xC6,0xC6,0x7E,0x0);
 CustomChar(101,0x0,0x0,0x7C,0xC6,0xFE,0xC0,0x7C,0x0);
 CustomChar(102,0x3E,0x60,0x60,0xFC,0x60,0x60,0x60,0x0);
 CustomChar(103,0x0,0x0,0x7E,0xC6,0xC6,0x7E,0x6,0x7C);
 CustomChar(104,0xC0,0xC0,0xFC,0xC6,0xC6,0xC6,0xC6,0x0);
 CustomChar(105,0x18,0x0,0x78,0x18,0x18,0x18,0x7E,0x0);
 CustomChar(106,0x18,0x0,0x38,0x18,0x18,0x18,0x18,0x70);
 CustomChar(107,0xC0,0xC0,0xC6,0xCC,0xF8,0xCC,0xC6,0x0);
 CustomChar(108,0x78,0x18,0x18,0x18,0x18,0x18,0x7E,0x0);
 CustomChar(109,0x0,0x0,0xEC,0xFE,0xD6,0xD6,0xC6,0x0);
 CustomChar(110,0x0,0x0,0xFC,0xC6,0xC6,0xC6,0xC6,0x0);
 CustomChar(111,0x0,0x0,0x7C,0xC6,0xC6,0xC6,0x7C,0x0);
 CustomChar(112,0x0,0x0,0xFC,0xC6,0xC6,0xFC,0xC0,0xC0);
 CustomChar(113,0x0,0x0,0x7E,0xC6,0xC6,0x7E,0x6,0x7);
 CustomChar(114,0x0,0x0,0xDC,0xF6,0xC0,0xC0,0xC0,0x0);
 CustomChar(115,0x0,0x0,0x7E,0xC0,0x7C,0x6,0xFC,0x0);
 CustomChar(116,0x30,0x30,0xFC,0x30,0x30,0x30,0x1E,0x0);
 CustomChar(117,0x0,0x0,0xC6,0xC6,0xC6,0xC6,0x7E,0x0);
 CustomChar(118,0x0,0x0,0xC6,0xC6,0x6C,0x38,0x10,0x0);
 CustomChar(119,0x0,0x0,0xC6,0xD6,0xD6,0xFE,0xC6,0x0);
 CustomChar(120,0x0,0x0,0xC6,0x6C,0x38,0x6C,0xC6,0x0);
 CustomChar(121,0x0,0x0,0xC6,0xC6,0xC6,0x7E,0x6,0x7C);
 CustomChar(122,0x0,0x0,0xFE,0xC,0x38,0x60,0xFE,0x0);
 CustomChar(123,0xC,0x18,0x18,0x70,0x18,0x18,0xC,0x0);
 CustomChar(124,0x18,0x18,0x18,0x0,0x18,0x18,0x18,0x0);
 CustomChar(125,0x30,0x18,0x18,0xE,0x18,0x18,0x30,0x0);
 CustomChar(126,0x31,0x6B,0x46,0x0,0x0,0x0,0x0,0x0);
}

void initFont(){
 if(DST_font == NULL ){
  DST_font = calloc(256,sizeof(DST_char));
 }
 if(BBCFont == NULL){
  BBCFont = calloc(256,sizeof(void*));
  char *c=calloc(8*256,sizeof(char));
  for(int i=0;i<256;i++){
   BBCFont[i]=c+8*i;
  }
 }
 DefaultFont();
}

void destroyFont(){
 if( ! BBCFont ) return;
 free(DST_font);  DST_font = NULL;
 free( BBCFont[0] );  free( BBCFont );  BBCFont = NULL;
}

void drawScaledText(int x, int y, int xs, int ys, char *msg){
 unsigned char *s = (unsigned char*)msg;
 if( ! mySdl2IsRunning ) return;

 if( xs<1 ) xs=1;
 if( ys<1 ) ys=1;

#if 0
 if(xs==1 && ys==1){
  Print(x,y,s);
  return;
 }
#endif

 if(y>winh || y+8*ys<0) return;
 int step = 8 * xs;

 if( x+step < 0 ){
  while( *s && (x+step<0) ){
   x += step;
   s ++ ;
  }
 }
 
 double _xs = xs*0.5;
 double _ys = ys*0.5;

 int fixx = xs == 1;
 int fixy = ys == 1;

 int i;
 while( *s ){

#if 1
  for(i=0; i<DST_font[*s].num_rects; i++){
   int xx = x+DST_font[*s].rects[i].x*_xs;
   int yy = y+DST_font[*s].rects[i].y*_ys;
   int ww = DST_font[*s].rects[i].w*_xs;
   int hh = DST_font[*s].rects[i].h*_ys;
   boxColor( myRenderer, xx, yy, xx+ww-fixx, yy+hh-fixy, currentColour );
  }
#endif

  if( xs != 1 && ys != 1 ){
   for(i=0; i<DST_font[*s].num_tris; i++){
    filledTrigonColor( myRenderer, x+DST_font[*s].tris[i].x1*_xs, y+DST_font[*s].tris[i].y1*_ys,
              x+DST_font[*s].tris[i].x2*_xs, y+DST_font[*s].tris[i].y2*_ys,
              x+DST_font[*s].tris[i].x3*_xs, y+DST_font[*s].tris[i].y3*_ys, currentColour );
   }
  }

  x += step; if(x>winw) return;
  s++;
 }//endwhile 
 
 return;
}

